# 자바의 메모리

## 스펙

### 메소드 영역
- 클래스 바이트코드 파일을 읽은 내용이 저장되는 정적인 영역
- 클래스 구조(Field Info, Method Info, Type Info), 메소드 및 생성자 코드, static 변수 등이 저장된다.
  - 단, static 변수가 가리키는 실제 객체는 힙 영역에 있다.
    - 객체 생성은 무조건 힙 영역에서, 메소드 영역에 있는 것은 static reference
  - final 과는 관련없음
- Runtime Constant Pool도 저장된다.
  - 클래스 로드시 클래스 파일의 상수 풀(Java 표준)을 JVM의 런타임 상수 풀(Implementation-specific)에 적절히 반영함
  - 개발자가 코드에 쓴 상수라기보다는 JVM이 바이트코드 처리를 위해 필요한 상수
    - 개발자가 코드에 쓴 상수도 클래스 파일 상수 풀에 저장되긴 함
    - 하지만 런타임 상수 풀에서는 구현에 따라 다름
      - 보통 구현에서는 정수와 실수는 런타임 상수 풀에 두고, 문자열은 힙 영역의 StringConstantPool에 저장함. 런타임 상수 풀에는 StringConstantPool에 대한 레퍼런스만 저장
  - 주로 클래스와 관련된 메타데이터, 심볼 테이블과 유사한 기능
  - 보통 메서드와 필드에 대한 레퍼런스도 저장, 어떤 메서드나 필드를 참조할 때 JVM은 런타임 상수 풀을 통해 실제 메모리상 주소를 찾아서 참조
- JVM 시작부터 종료까지 유지된다.

### 힙 영역
- 객체가 생성되는 영역
- 메소드 영역이나 스택 영역에 있는 변수에서 레퍼런스를 가지고 있음
- 코드에 사용되는 문자열 상수를 객체로 미리 저장하고 공유하는 StringConstantPool도 있음

### 스택 영역
- 메소드를 호출할 때마다 생기는 스택 프레임이 저장되는 영역
- 프레임 안에는 지역 변수 및 매개 변수를 저장하는 영역이 있다.
  - 기본 타입 변수는 값을, 참조 타입 변수는 레퍼런스를 저장함

## 구현 (HotSpot)

- 실제 구현은 스펙에 제시된 영역 그대로 메모리를 통으로 3분할한 구조는 아니다.
- 스펙상의 영역에 포함된 세부 데이터 항목별로, 구현에 따라 메모리에 들어가는 위치가 다르다.
- 스펙은 논리적인 개념이고, 실제 JVM은 완전히 동일한 느낌의 구조로 구현되어 있지는 않다.
  - 스펙상의 어떤 항목이 구현상의 어떤 항목과 일치한다고 1:1 매칭을 하기는 어렵다.

![image](https://github.com/njw1204/TIL/assets/38099251/75153f7d-61ce-4622-b926-3f9b337bbd6f)

- Java Heap: JVM에 의해 관리되는 영역, 가비지 컬렉션이 가능하다. (-Xms, -Xmx로 크기 조정)
  - Young Generation
    - Eden: 새로 생긴 객체가 저장된다.
    - Survivor 0, 1: Minor GC 이후 살아남은 객체가 저장된다.
  - Old Generation: Minor GC 이후 Age Threshold에 도달한 객체가 저장된다.
- Permanent Heap: JVM에 의해 관리되는 영역, 가비지 컬렉션이 가능하다. Java 7까지만 존재한다.
  - Permanent Generation
    - 메소드 영역이 저장된다.
    - Java 6까지는 StringConstantPool도 저장한다. 이후 Java Heap으로 위치 변경됨
      - 모든 클래스의 인스턴스는 Java Heap에 존재하게 되었다.
- Native Memory: OS에 의해 관리되는 영역
  - Metaspace: Java 8부터 등장했다. 가비지 컬렉션이 가능하다.
    - JVM이 관리하던 PermGen과 달리, OS의 메모리를 직접 사용하여 상한 없이 자동 크기 증가가 가능하다.
    - 메소드 영역이 저장되지만, 메타데이터만 저장한다.
      - static 변수는 Java Heap에 저장되는 것으로 변경되었다.
      - static 변수가 가리키는 인스턴스는 예전과 동일하게 계속 Java Heap에 저장한다.
